name: "Build and Cache NixOS Configurations"

on:
  pull_request:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  # Start EC2 runners for each system in parallel
  start-runners:
    timeout-minutes: 5
    name: Start EC2 runner (${{ matrix.system }})
    runs-on: ubuntu-latest
    permissions:
      actions: write
    strategy:
      matrix:
        system: [norway, china, japan]
    steps:
      - name: Start EC2 runner
        id: start-ec2-runner
        uses: NextChapterSoftware/ec2-action-builder@v1.10
        with:
          github_token: ${{ secrets.GH_PERSONAL_ACCESS_TOKEN }}
          aws_access_key_id: ${{ secrets.DEPLOY_AWS_ACCESS_KEY_ID }}
          aws_secret_access_key: ${{ secrets.DEPLOY_AWS_SECRET_ACCESS_KEY }}
          aws_region: "ap-southeast-2"
          ec2_instance_type: c6i.4xlarge
          ec2_root_disk_size_gb: "100"
          ec2_ami_id: ami-09e143e99e8fa74f9
          ec2_subnet_id: "subnet-e54cb9ad"
          ec2_security_group_id: "sg-c4dfe0b2"
          ec2_instance_ttl: 60
          ec2_spot_instance_strategy: BestEffort

  # Build each system in parallel on separate runners
  build:
    timeout-minutes: 90
    name: Build ${{ matrix.system }}
    needs: start-runners
    runs-on: ${{ github.run_id }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - system: norway
            config: jacob-norway
            description: "Primary Laptop"
          - system: china
            config: jacob-china
            description: "Home Server"
          - system: japan
            config: jacob-japan
            description: "Steam Deck"
    steps:
      - name: Setup runner environment
        run: |
          mkdir -p /home/runner
          chmod -R 777 /home/runner
          echo "HOME=/home/runner" >> $GITHUB_ENV

      - uses: actions/checkout@v4

      - name: Install Nix
        uses: cachix/install-nix-action@v25
        with:
          nix_path: nixpkgs=channel:nixos-unstable
          extra_nix_config: |
            experimental-features = nix-command flakes
            accept-flake-config = true

      - name: Setup Cachix
        uses: cachix/cachix-action@v14
        with:
          name: jpyke3
          authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'

      - name: Setup Magic Nix Cache
        uses: DeterminateSystems/magic-nix-cache-action@v2

      - name: Connect to Tailscale
        uses: tailscale/github-action@v2
        with:
          oauth-client-id: ${{ secrets.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ secrets.TS_OAUTH_SECRET }}
          tags: tag:ci

      - name: Setup Attic client
        run: |
          nix profile install nixpkgs#attic-client
          attic login main http://jacob-china:5000 ${{ secrets.ATTIC_TOKEN }}

      - name: Build ${{ matrix.config }} (${{ matrix.description }})
        run: |
          echo "Building ${{ matrix.config }}..."
          nix build .#nixosConfigurations.${{ matrix.config }}.config.system.build.toplevel \
            --no-link --print-out-paths > build-paths.txt
          echo "Build complete"
          cat build-paths.txt

      - name: Push to Attic cache
        run: |
          echo "Pushing ${{ matrix.config }} to Attic cache..."
          while read -r path; do
            echo "Pushing $path"
            attic push main "$path" || echo "Warning: Failed to push $path"
          done < build-paths.txt
          echo "Push complete"

      - name: Build summary
        if: always()
        run: |
          echo "=== Build Summary for ${{ matrix.config }} ==="
          echo "System: ${{ matrix.description }}"
          echo "Paths built:"
          cat build-paths.txt 2>/dev/null || echo "No paths (build may have failed)"
