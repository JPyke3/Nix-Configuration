name: "Build Steam Deck Packages"
on:
  pull_request:
  push:
jobs:
  start-runner:
    timeout-minutes: 5              # normally it only takes 1-2 minutes
    name: Start self-hosted EC2 runner   
    runs-on: ubuntu-latest
    permissions:
      actions: write        
    steps:      
      - name: Start EC2 runner
        id: start-ec2-runner
        uses: NextChapterSoftware/ec2-action-builder@v1.10
        with:
          github_token: ${{ secrets.GH_PERSONAL_ACCESS_TOKEN }}
          aws_access_key_id: ${{ secrets.DEPLOY_AWS_ACCESS_KEY_ID }}
          aws_secret_access_key: ${{ secrets.DEPLOY_AWS_SECRET_ACCESS_KEY }}
          aws_region: "us-east-2"
          ec2_instance_type: c5a.8xlarge
          ec2_root_disk_size_gb: "100"
          ec2_ami_id: ami-0cb91c7de36eed2cb
          ec2_iam_instance_profile: EC2GitHubActionsRole
          ec2_subnet_id: "subnet-0de957e3a1a79a651"
          ec2_security_group_id: "sg-080bb88987d22d2a3"
          ec2_instance_ttl: 40                # Optional (default is 60 minutes)
          ec2_spot_instance_strategy: SpotOnly

  run-build:
    timeout-minutes: 1
    needs:
      - start-runner
    runs-on: ${{ github.run_id }}
    steps:
    - uses: actions/checkout@v4
    - uses: cachix/install-nix-action@v25
      with:
        nix_path: nixpkgs=channel:nixos-unstable
    - uses: cachix/cachix-action@v14
      with:
        name: jpyke3
        authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
    - run: nix build .#nixosConfigurations.jacob-japan.config.system.build.toplevel
    - run: nix flake check
